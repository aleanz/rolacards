// Prisma Schema for Rola Cards
// TCG Card Shop Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          Role      @default(STAFF)
  avatar        String?
  emailVerified Boolean   @default(false)
  verificationToken String? @unique
  konamiId      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sales         Sale[]
  createdEvents Event[]   @relation("EventCreator")
  createdNews   News[]    @relation("NewsCreator")
  decks         Deck[]
  registrations EventRegistration[]
}

enum Role {
  ADMIN
  STAFF
  CLIENTE
}

// ============================================
// EVENTS & TOURNAMENTS
// ============================================

model Event {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  description String?     @db.Text
  content     String?     @db.Text
  date        DateTime
  endDate     DateTime?
  location    String?
  type        EventType
  format      String?     // Tournament format (Standard, Advanced, etc.)
  entryFee    Decimal?    @db.Decimal(10, 2)
  maxPlayers  Int?
  prizeInfo   String?     @db.Text
  imageUrl    String?
  published   Boolean     @default(false)
  featured    Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  creatorId   String
  creator     User        @relation("EventCreator", fields: [creatorId], references: [id])
  registrations EventRegistration[]

  @@index([date])
  @@index([type])
  @@index([published])
}

enum EventType {
  TOURNAMENT
  SNEAK_PEEK
  LOCALS
  SPECIAL_EVENT
  ANNOUNCEMENT
}

// ============================================
// NEWS & ANNOUNCEMENTS
// ============================================

model News {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  excerpt     String?   @db.VarChar(300)
  content     String    @db.Text
  imageUrl    String?
  category    NewsCategory
  published   Boolean   @default(false)
  featured    Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  creatorId   String
  creator     User      @relation("NewsCreator", fields: [creatorId], references: [id])
  
  @@index([category])
  @@index([published])
  @@index([publishedAt])
}

enum NewsCategory {
  NEWS
  PROMO
  UPDATE
  GUIDE
}

// ============================================
// GALLERY & MEDIA
// ============================================

model GalleryImage {
  id          String    @id @default(cuid())
  title       String?
  description String?
  url         String
  thumbnail   String?
  category    GalleryCategory @default(STORE)
  order       Int       @default(0)
  published   Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@index([category])
  @@index([order])
}

enum GalleryCategory {
  STORE
  EVENTS
  PRODUCTS
  COMMUNITY
}

// ============================================
// PRODUCTS & INVENTORY
// ============================================

model Product {
  id          String        @id @default(cuid())
  sku         String        @unique
  name        String
  description String?       @db.Text
  type        ProductType
  price       Decimal       @db.Decimal(10, 2)
  cost        Decimal?      @db.Decimal(10, 2)
  stock       Int           @default(0)
  minStock    Int           @default(0)
  imageUrl    String?
  
  // Card-specific fields (for singles)
  cardId      Int?          // YGOProDeck card ID
  cardName    String?
  cardSet     String?
  cardRarity  String?
  cardCondition CardCondition?
  cardLanguage String?      @default("en")
  cardData    Json?         // Cached data from YGOProDeck API
  
  // Sealed product fields
  setCode     String?
  releaseDate DateTime?
  arrivalDate DateTime?     // Fecha de llegada a tienda
  location    String?       // Ubicaci√≥n en tienda
  notes       String?       @db.Text

  active      Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relations
  categoryId  String?
  category    Category?     @relation(fields: [categoryId], references: [id])
  saleItems   SaleItem[]
  stockHistory StockHistory[]
  
  @@index([type])
  @@index([cardId])
  @@index([active])
  @@index([stock])
}

enum ProductType {
  SINGLE        // Individual card
  BOOSTER       // Booster pack
  BOX           // Booster box
  STRUCTURE     // Structure deck
  TIN           // Collector tin
  ACCESSORY     // Sleeves, mats, etc.
  OTHER
}

enum CardCondition {
  MINT
  NEAR_MINT
  LIGHT_PLAY
  MODERATE_PLAY
  HEAVY_PLAY
  DAMAGED
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  order       Int       @default(0)
  
  // Relations
  products    Product[]
}

model StockHistory {
  id          String          @id @default(cuid())
  productId   String
  product     Product         @relation(fields: [productId], references: [id])
  type        StockMovement
  quantity    Int
  previousStock Int
  newStock    Int
  note        String?
  createdAt   DateTime        @default(now())
  
  @@index([productId])
  @@index([createdAt])
}

enum StockMovement {
  PURCHASE    // Stock added from supplier
  SALE        // Stock reduced from sale
  ADJUSTMENT  // Manual adjustment
  RETURN      // Customer return
  DAMAGE      // Damaged/lost
}

// ============================================
// SALES
// ============================================

model Sale {
  id          String      @id @default(cuid())
  number      Int         @unique @default(autoincrement())
  date        DateTime    @default(now())
  subtotal    Decimal     @db.Decimal(10, 2)
  discount    Decimal     @default(0) @db.Decimal(10, 2)
  tax         Decimal     @default(0) @db.Decimal(10, 2)
  total       Decimal     @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  status      SaleStatus  @default(COMPLETED)
  notes       String?
  
  // Customer info (optional)
  customerName  String?
  customerEmail String?
  customerPhone String?
  
  // Relations
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  items       SaleItem[]
  
  @@index([date])
  @@index([userId])
  @@index([status])
}

model SaleItem {
  id          String    @id @default(cuid())
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  discount    Decimal   @default(0) @db.Decimal(10, 2)
  total       Decimal   @db.Decimal(10, 2)
  
  // Relations
  saleId      String
  sale        Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  
  @@index([saleId])
  @@index([productId])
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  MIXED
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

// ============================================
// STORE SETTINGS
// ============================================

model StoreSetting {
  id          String    @id @default(cuid())
  key         String    @unique
  value       String    @db.Text
  type        SettingType @default(STRING)
  updatedAt   DateTime  @updatedAt
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// ============================================
// DECK BUILDER & EVENT REGISTRATIONS
// ============================================

model EventRegistration {
  id            String              @id @default(cuid())
  status        RegistrationStatus  @default(PENDIENTE)
  rejectionNote String?             @db.Text
  konamiId      String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  userId        String
  user          User                @relation(fields: [userId], references: [id])
  eventId       String
  event         Event               @relation(fields: [eventId], references: [id])
  deckId        String
  deck          Deck                @relation(fields: [deckId], references: [id])

  @@unique([userId, eventId])
  @@index([eventId, status])
}

enum RegistrationStatus {
  PENDIENTE
  APROBADO
  RECHAZADO
}

model Deck {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  format      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      String
  user        User     @relation(fields: [userId], references: [id])
  cards       DeckCard[]
  registrations EventRegistration[]

  @@index([userId])
}

model DeckCard {
  id       String   @id @default(cuid())
  cardId   Int
  quantity Int      @default(1)
  deckType DeckType
  cardData Json

  deckId   String
  deck     Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([deckId, cardId, deckType])
  @@index([deckId])
}

enum DeckType {
  MAIN
  EXTRA
  SIDE
}
