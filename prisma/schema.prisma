generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id          String    @id
  name        String    @unique
  slug        String    @unique
  description String?
  order       Int       @default(0)
  Product     Product[]
}

model Deck {
  id                String              @id
  name              String
  description       String?
  format            String?
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  userId            String
  User              User                @relation(fields: [userId], references: [id])
  DeckCard          DeckCard[]
  EventRegistration EventRegistration[]
  TournamentPlayer  TournamentPlayer[]

  @@index([userId])
}

model DeckCard {
  id       String   @id
  cardId   Int
  quantity Int      @default(1)
  deckType DeckType
  cardData Json
  deckId   String
  Deck     Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([deckId, cardId, deckType])
  @@index([deckId])
}

model Event {
  id                  String              @id
  title               String
  slug                String              @unique
  description         String?
  content             String?
  date                DateTime
  endDate             DateTime?
  location            String?
  type                EventType
  format              String?
  genesysPointsLimit  Int?
  entryFee            Decimal?            @db.Decimal(10, 2)
  maxPlayers          Int?
  prizeInfo           String?
  imageUrl            String?
  published           Boolean             @default(false)
  featured            Boolean             @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  creatorId           String
  User                User                @relation(fields: [creatorId], references: [id])
  EventRegistration   EventRegistration[]

  @@index([date])
  @@index([published])
  @@index([type])
}

model EventRegistration {
  id                String              @id
  status            RegistrationStatus  @default(PENDIENTE)
  rejectionNote     String?
  konamiId          String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  userId            String
  eventId           String
  deckId            String
  paymentProof      String?
  paymentProofType  String?
  paymentVerified   Boolean             @default(false)
  transferReference String?
  verifiedAt        DateTime?
  verifiedBy        String?
  Deck              Deck                @relation(fields: [deckId], references: [id])
  Event             Event               @relation(fields: [eventId], references: [id])
  User              User                @relation(fields: [userId], references: [id])
  TournamentPlayer  TournamentPlayer?

  @@unique([userId, eventId])
  @@index([eventId, status])
  @@index([status])
}

model GalleryImage {
  id          String          @id
  title       String?
  description String?
  url         String
  thumbnail   String?
  category    GalleryCategory @default(STORE)
  order       Int             @default(0)
  published   Boolean         @default(true)
  createdAt   DateTime        @default(now())

  @@index([category])
  @@index([order])
}

model News {
  id          String       @id
  title       String
  slug        String       @unique
  excerpt     String?      @db.VarChar(300)
  content     String
  imageUrl    String?
  category    NewsCategory
  published   Boolean      @default(false)
  featured    Boolean      @default(false)
  publishedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  creatorId   String
  User        User         @relation(fields: [creatorId], references: [id])

  @@index([category])
  @@index([publishedAt])
  @@index([published])
}

model Order {
  id                  String      @id
  orderNumber         Int         @unique @default(autoincrement())
  status              OrderStatus @default(PENDING)
  quantity            Int         @default(1)
  unitPrice           Decimal     @db.Decimal(10, 2)
  total               Decimal     @db.Decimal(10, 2)
  paymentProofUrl     String?
  transferReference   String?
  rejectionNote       String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime
  approvedAt          DateTime?
  rejectedAt          DateTime?
  userId              String
  productId           String
  approvedBy          String?
  User                User        @relation(fields: [userId], references: [id])
  ApprovedByUser      User?       @relation("OrderApprovals", fields: [approvedBy], references: [id])

  @@index([userId])
  @@index([productId])
  @@index([status])
  @@index([createdAt])
}

model Product {
  id            String         @id
  sku           String         @unique
  name          String
  description   String?
  type          ProductType
  price         Decimal        @db.Decimal(10, 2)
  cost          Decimal?       @db.Decimal(10, 2)
  stock         Int            @default(0)
  minStock      Int            @default(0)
  imageUrl      String?
  cardId        Int?
  cardName      String?
  cardSet       String?
  cardRarity    String?
  cardCondition CardCondition?
  cardLanguage  String?        @default("en")
  cardData      Json?
  setCode       String?
  releaseDate   DateTime?
  arrivalDate   DateTime?
  location      String?
  notes         String?
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  categoryId    String?
  Category      Category?      @relation(fields: [categoryId], references: [id])
  SaleItem      SaleItem[]
  StockHistory  StockHistory[]

  @@index([active])
  @@index([cardId])
  @@index([stock])
  @@index([type])
}

model Sale {
  id            String        @id
  number        Int           @unique @default(autoincrement())
  date          DateTime      @default(now())
  subtotal      Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  tax           Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  status        SaleStatus    @default(COMPLETED)
  notes         String?
  customerName  String?
  customerEmail String?
  customerPhone String?
  userId        String
  User          User          @relation(fields: [userId], references: [id])
  SaleItem      SaleItem[]

  @@index([date])
  @@index([status])
  @@index([userId])
}

model SaleItem {
  id        String  @id
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  discount  Decimal @default(0) @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)
  saleId    String
  productId String
  Product   Product @relation(fields: [productId], references: [id])
  Sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([saleId])
}

model StockHistory {
  id            String        @id
  productId     String
  type          StockMovement
  quantity      Int
  previousStock Int
  newStock      Int
  note          String?
  createdAt     DateTime      @default(now())
  Product       Product       @relation(fields: [productId], references: [id])

  @@index([createdAt])
  @@index([productId])
}

model Sponsor {
  id        String   @id
  name      String
  logoUrl   String
  linkUrl   String
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([active])
  @@index([order])
}

model StoreSetting {
  id        String      @id
  key       String      @unique
  value     String
  type      SettingType @default(STRING)
  updatedAt DateTime
}

model User {
  id                   String              @id
  email                String              @unique
  password             String
  name                 String
  role                 Role                @default(STAFF)
  avatar               String?
  emailVerified        Boolean             @default(false)
  verificationToken    String?             @unique
  resetPasswordToken   String?             @unique
  resetPasswordExpires DateTime?
  konamiId             String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime
  Deck                 Deck[]
  Event                Event[]
  EventRegistration    EventRegistration[]
  News                 News[]
  Sale                 Sale[]
  Order                Order[]
  OrderApprovals       Order[]             @relation("OrderApprovals")
  TournamentPlayer     TournamentPlayer[]
  TournamentsCreated   Tournament[]
}

enum CardCondition {
  MINT
  NEAR_MINT
  LIGHT_PLAY
  MODERATE_PLAY
  HEAVY_PLAY
  DAMAGED
}

enum DeckType {
  MAIN
  EXTRA
  SIDE
}

enum EventType {
  TOURNAMENT
  SNEAK_PEEK
  LOCALS
  SPECIAL_EVENT
  ANNOUNCEMENT
}

enum GalleryCategory {
  STORE
  EVENTS
  PRODUCTS
  COMMUNITY
}

enum NewsCategory {
  NEWS
  PROMO
  UPDATE
  GUIDE
}

enum OrderStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  MIXED
}

enum ProductType {
  SINGLE
  BOOSTER
  BOX
  STRUCTURE
  TIN
  ACCESSORY
  OTHER
}

enum RegistrationStatus {
  PENDIENTE
  APROBADO
  RECHAZADO
}

enum Role {
  ADMIN
  STAFF
  CLIENTE
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

enum StockMovement {
  PURCHASE
  SALE
  ADJUSTMENT
  RETURN
  DAMAGE
}

// ==================== SISTEMA DE TORNEOS ====================

model Tournament {
  id                String              @id
  name              String
  slug              String              @unique
  description       String?
  format            String?             // avanzado, ocg, goat, edison, genesys
  date              DateTime
  location          String?
  entryFee          Decimal?            @db.Decimal(10, 2)
  maxPlayers        Int?
  prizeInfo         String?
  imageUrl          String?

  // Estado del torneo
  status            TournamentStatus    @default(REGISTRATION)
  currentRound      Int                 @default(0)
  totalRounds       Int                 @default(0)
  roundTimeMinutes  Int                 @default(50)

  // Configuración
  tier              TournamentTier      @default(TIER_1)

  // Metadata
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  creatorId         String

  // Relaciones
  Creator           User                @relation(fields: [creatorId], references: [id])
  Participants      TournamentPlayer[]
  Matches           TournamentMatch[]

  @@index([date])
  @@index([status])
}

model TournamentPlayer {
  id                String              @id

  // Puntuación
  matchPoints       Int                 @default(0)
  matchWins         Int                 @default(0)
  matchLosses       Int                 @default(0)
  matchDraws        Int                 @default(0)
  gameWins          Int                 @default(0)
  gameLosses        Int                 @default(0)

  // Tiebreakers (se calculan dinámicamente pero se cachean)
  opponentMatchWinPct   Float           @default(0)
  gameWinPct            Float           @default(0)
  opponentGameWinPct    Float           @default(0)

  // Estado
  isActive          Boolean             @default(true)
  hasBye            Boolean             @default(false)
  dropped           Boolean             @default(false)
  droppedAtRound    Int?

  // Seed inicial (para desempate final)
  seed              Int                 @default(0)

  // Datos del jugador externo (cuando no tiene cuenta en el sistema)
  externalName      String?
  externalKonamiId  String?

  // Relaciones
  tournamentId      String
  userId            String?
  deckId            String?
  registrationId    String?             @unique

  Tournament        Tournament          @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  User              User?               @relation(fields: [userId], references: [id])
  Deck              Deck?               @relation(fields: [deckId], references: [id])
  Registration      EventRegistration?  @relation(fields: [registrationId], references: [id])

  MatchesAsPlayer1  TournamentMatch[]   @relation("Player1Matches")
  MatchesAsPlayer2  TournamentMatch[]   @relation("Player2Matches")
  MatchesAsWinner   TournamentMatch[]   @relation("WinnerMatches")

  @@unique([tournamentId, externalKonamiId])
  @@index([tournamentId, userId])
  @@index([tournamentId])
  @@index([matchPoints])
}

model TournamentMatch {
  id                String              @id
  round             Int
  table             Int                 @default(1)

  // Resultado
  player1Wins       Int                 @default(0)
  player2Wins       Int                 @default(0)
  draws             Int                 @default(0)

  // Estado
  status            MatchStatus         @default(PENDING)
  isBye             Boolean             @default(false)

  // Tiempos
  startedAt         DateTime?
  finishedAt        DateTime?

  // Relaciones
  tournamentId      String
  player1Id         String?
  player2Id         String?
  winnerId          String?

  Tournament        Tournament          @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  Player1           TournamentPlayer?   @relation("Player1Matches", fields: [player1Id], references: [id])
  Player2           TournamentPlayer?   @relation("Player2Matches", fields: [player2Id], references: [id])
  Winner            TournamentPlayer?   @relation("WinnerMatches", fields: [winnerId], references: [id])

  @@index([tournamentId, round])
  @@index([status])
}

enum TournamentStatus {
  REGISTRATION      // Inscripciones abiertas
  READY             // Listo para iniciar
  IN_PROGRESS       // Rondas suizas en curso
  TOP_CUT           // Eliminación directa
  FINISHED          // Torneo terminado
  CANCELLED         // Cancelado
}

enum TournamentTier {
  TIER_1            // Locals (4-8: 3 rondas, etc.)
  TIER_2            // Regionales
  TIER_3            // YCS/WCQ
  TIER_4            // Mundiales
}

enum MatchStatus {
  PENDING           // Sin iniciar
  IN_PROGRESS       // En curso
  FINISHED          // Terminada
  NO_SHOW           // No se presentó
}
